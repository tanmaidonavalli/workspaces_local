---
- hosts: all
  become: yes
  become_method: sudo
  gather_facts: true
  tasks:
  - name: Install wget package (RedHat based)
    action: yum name='wget' state=installed

  - name: Download MySQL Community Repo
    shell: wget http://repo.mysql.com/mysql-community-release-el7-5.noarch.rpm

  - name: remove rpm
    shell: yum -y remove mysql-community-release-el7-5.noarch

  - name: doqnload rpm
    shell: rpm -ivh mysql-community-release-el7-5.noarch.rpm
  - name: Install MySQL-python, this is required for the task remove anonymous user
    yum: name=MySQL-python state=present


  - name: Install MySQL Server
    yum: name=mysql-server state=present
    
  - shell: grep 'temporary password' /var/log/mysqld.log | awk '{print $NF}';
    register: result
  -  set_fact:
      mysql_root_pw: "{{ result.stdout }}"
      
  - stat: path=/root/.my.cnf
    register: sym
  - set_fact: mysql_root_pw="{{ masterpassword }}"
    when: sym.stat.exists == True

  - name: install .my.cnf with credentials
    template: src=my.cnf.j2 dest=/root/.my.cnf
              mode=0400
    tags: my_cnf

  - name: Set the root password for MySQL Database
    command:  mysql -u root --connect-expired-password --execute="SET PASSWORD = PASSWORD('{{ masterpassword }}');"
    
  -  set_fact:
      mysql_root_pw: "{{ masterpassword }}"

  - name: install .my.cnf with credentials
    template: src=my.cnf.j2 dest=/root/.my.cnf
              mode=0400
    tags: my_cnf


  - name: Start MySQL Server and enable it
    service: name=mysqld state=started enabled=yes
